<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FICup Formazione - Maghetto</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* ---------- base ---------- */
  :root{
    --gold:#ffd700;
    --gold-dark:#e6b800;
  }
  body{
    font-family:'Poppins',sans-serif;
    background:transparent;
    margin:0;
    padding:8px;
    color:#fff;
    text-align:center;
  }

  /* ---------- titolo ---------- */
  .title{
    font-family:'Dancing Script',cursive;
    font-size:22px;
    font-weight:700;
    margin-bottom:6px;
    background:linear-gradient(45deg,var(--gold),#fffacd,var(--gold));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    text-shadow:0 0 4px #fff,0 0 8px var(--gold);
    animation:glitter 2s infinite alternate;
  }
  @keyframes glitter{
    0%{text-shadow:0 0 3px #fff,0 0 6px var(--gold);}
    50%{text-shadow:0 0 6px #fff,0 0 12px var(--gold);}
    100%{text-shadow:0 0 3px #fff,0 0 6px var(--gold);}
  }

  /* ---------- contenitore / campo ---------- */
  .field-container{position:relative;max-width:320px;margin:0 auto; left:-5px;}
.field{
  position:relative;
  width:100%;
  aspect-ratio:3/4.5;
  background:linear-gradient(120deg,#0b6623,#0f8a3d,#0b6623);
  border-radius:10px;
  box-shadow:inset 0 8px 18px rgba(0,0,0,0.55);
  overflow:hidden;
  padding:6px;
}

/* --- Linee del campo --- */
.half-line {
  position: absolute;
  top: 50%;
  left: 0;
  width: 100%;
  height: 2px;
  background: rgba(255,255,255,0.7);
  transform: translateY(-50%);
  z-index: 1;
}

.center-circle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 54px;
  height: 54px;
  border: 2px solid rgba(255,255,255,0.7);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  z-index: 1;
}

.goal-area {
  position: absolute;
  left: 50%;
  width: 50px;
  height: 30px;
  border: 2px solid rgba(255,255,255,0.7);
  transform: translateX(-50%);
  z-index: 1;
}
.goal-top { top: 6px; }
.goal-bottom { bottom: 6px; }

/* firma FICup */
.signature{
  position:absolute;
  top:6px;
  right:8px;
  font-family:'Dancing Script',cursive;
  font-size:14px;
  font-weight:700;
  color:var(--gold);
  text-shadow:0 0 4px #fff,0 0 6px var(--gold);
  z-index:4;
}


  /* maghetto oscillante */
  .maghetto{
    position:absolute;
    top:-22px;
    left:-26px;
    width:110px;
    z-index:4;
    filter:drop-shadow(0 4px 10px rgba(0,0,0,0.45));
    animation:oscilla 2.6s infinite ease-in-out;
  }
  @keyframes oscilla{
    0%{transform:translateY(0) rotate(0deg);}
    50%{transform:translateY(-4px) rotate(3deg);}
    100%{transform:translateY(0) rotate(0deg);}
  }

  /* stelline - inizialmente invisibili (generate dopo genera) */
  .star{
    position:absolute;
    width:3px;height:3px;border-radius:50%;
    background:var(--gold);
    opacity:0; transform:scale(0.6);
    animation:starBlink 1.8s linear infinite;
    animation-play-state:paused;
  }
  @keyframes starBlink{
    0%{opacity:0; transform:scale(0.6) translateY(0);}
    30%{opacity:1; transform:scale(1) translateY(-4px);}
    60%{opacity:0.6; transform:scale(0.8) translateY(-8px);}
    100%{opacity:0; transform:scale(0.6) translateY(0);}
  }
  .stars-active .star{ animation-play-state:running; }

  /* bacchetta magica */
  .magic-stick{
    position:absolute;
    bottom:6px;
    left:6px;
    font-size:24px;
    opacity:0.8;
    cursor:not-allowed;
    z-index:5;
    transition:transform .18s ease;
  }
  .magic-stick.active{ cursor:pointer; animation:wandMove 1.6s infinite alternate; }
  @keyframes wandMove{
    0%{transform:translateY(0) rotate(0deg);}
    50%{transform:translateY(-3px) rotate(6deg);}
    100%{transform:translateY(0) rotate(0deg);}
  }

  /* linee e giocatori (card compatte) */
  .line{ display:flex; justify-content:center; gap:15px; margin-top:14px; }
  .player-card{
    background:rgba(255,255,255,0.12);
    border-radius:6px;
    padding:4px;
    width:61px;
    text-align:center;
    opacity:0; transform:translateY(8px);
    animation:fadeInUp .45s forwards;
  }
  .player-card img{
    width:22px; height:25px; border-radius:50%; object-fit:cover; background:#fff; padding:1px;
  }
  .name{ font-size:11px; font-weight:600; line-height:1; }
  .team{ font-size:9px; opacity:0.85; line-height:1; }
  .mv,.gf,.ass{ font-size:9px; color:#ffcc00; margin-top:2px; line-height:1; }
  @keyframes fadeInUp{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }

  /* ---------- overlay video + box consiglio (video centrato) ---------- */
  .overlay{
    position:fixed;
    left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:340px; max-width:92%;
    background:transparent;
    border-radius:12px;
    padding:0;
    display:none;
    z-index:9999;
    animation:overlayFade .35s ease;
  }
  @keyframes overlayFade{ from{opacity:0; transform:translate(-50%,-48%);} to{opacity:1; transform:translate(-50%,-50%);} }

  .overlay-inner{
    position:relative;
    width:100%;
    background:transparent;
    border-radius:12px;
    overflow:visible;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:8px 8px 12px 8px;
  }

  /* wrapper video: video √® centrato, bordato d'oro */
  .video-wrap{
    position:relative;
    width:100%;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .video-wrap video{
    width:94%;
    border-radius:10px;
    border:3px solid var(--gold);
    display:block;
    background:#000;
    transition:filter .25s ease, transform .25s ease;
  }

  /* BOX CONSIGLIO che copre la met√† inferiore del video (non trasparente) */
  .advice-box{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    bottom:1%; /* overlap */
    width:92%;
    height:30%; /* copre met√† inferiore del video area */
    background:var(--gold);
    color:#000;
    border-radius:8px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-start;
    padding:10px 12px;
    box-sizing:border-box;
    z-index:8;
    box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  }
.advice-box .advice-title {
  font-family: 'Dancing Script', cursive;
  font-size: 25px;
  font-weight: 700;
  margin-bottom: 6px;
  color: #000; /* testo nero */
}
  .advice-details{ font-size:13px; color:#000; line-height:1.2; text-align:left; width:100%; }

  /* pulsanti chiudi */
  .close-big{
    margin-top:10px;
    padding:8px 14px;
    background:rgba(255,76,76,0.9);
    color:#fff;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
  }

  /* ---------- controlli (genera, svuota, whatsapp) ---------- */
  .controls{
    display:flex; justify-content:center; align-items:center; gap:8px; margin-top:10px;
  }
  button{
    border:none; border-radius:10px; padding:6px 12px; font-size:12px; font-weight:700; color:#fff; cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.35);
    backdrop-filter: blur(4px);
  }
  #genera{ background: rgba(255,215,0,0.7); }
  #svuota{ background: rgba(255,76,76,0.7); }
  button.loading{ pointer-events:none; opacity:0.6; }
  .hourglass{ display:inline-block; animation:spinHourglass 1s linear infinite; margin-right:6px; }
  @keyframes spinHourglass{ 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }

  /* whatsapp icon */
  .whatsapp-icon{ width:26px; height:26px; cursor:pointer; transition:transform .18s; }
  .whatsapp-icon:hover{ transform:scale(1.08); }

  /* responsive tweaks */
  @media (max-width:380px){
    .overlay{ width:300px; }
    .advice-box{ height:50%; }
    .player-card{ width:48px; }
  }
/* üîÆ Contenitore nero unico per maghetto + box testo */
.maghetto-container {
  background: #000;                /* nero pieno */
  border: 3px solid var(--gold);   /* unico bordo dorato */
  border-radius: 14px;
  padding: 14px;
  width: 94%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
}

/* üîÆ Maghetto sopra */
.maghetto-box {
  width: 100%;                     /* stessa larghezza del contenitore */
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.3s ease;
  background: #000;
  z-index: 1;                       /* dietro il box dorato */
  position: relative;
}

/* üìú Box dorato del testo consiglio */
.advice-box {
  background: #FFD700;              /* dorato pieno */
  color: #000; 
  border-radius: 12px;
  padding: 14px;
  width: 100%;                      /* stessa larghezza del contenitore */
  margin-top: -30px;                /* solleva sopra parte inferiore immagine */
  text-align: center;
  font-weight: 600;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  position: relative;
  z-index: 2;                       /* sopra l‚Äôimmagine */
}
</style>
</head>
<body>

  <div class="field-container">
    <div class="title">I consigli del maghetto</div>

    <img id="maghetto" class="maghetto" src="https://i.ibb.co/8LP0zhLY/1762282260694.png" alt="Maghetto">
<div class="field" id="campo">
  <div class="signature">FICup</div>

  <!-- Linee del campo -->
  <div class="half-line"></div>
  <div class="center-circle"></div>
  <div class="goal-area goal-top"></div>
  <div class="goal-area goal-bottom"></div>

  <!-- Righe giocatori -->
  <div id="goalkeeper" class="line"></div>
  <div id="defenders" class="line"></div>
  <div id="midfielders" class="line"></div>
  <div id="forwards" class="line"></div>

  <div id="magicStick" class="magic-stick" title="Bacchetta magica (attiva dopo Genera)">ü™Ñ</div>
</div>

  </div>

  <div class="controls" role="group" aria-label="Controlli">
    <button id="genera" type="button">Genera</button>
    <button id="svuota" type="button">Svuota</button>
    <img class="whatsapp-icon" id="waIcon" src="https://i.ibb.co/ymmkC9hw/Whats-App-svg.png" alt="WhatsApp">
  </div>

  <!-- üîÆ overlay maghetto + box consiglio -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="overlay-inner">
    <div class="video-wrap">
      
      <!-- üîÆ contenitore unico dorato -->
      <div class="maghetto-container">
        <img id="overlayMaghetto" 
             src="https://i.ibb.co/23ptLRZf/1762348597465.png" 
             alt="Maghetto Consigli" 
             class="maghetto-box">
        
        <!-- box consiglio (ora dentro lo stesso contenitore dorato) -->
        <div id="adviceBox" class="advice-box" aria-live="polite" role="region" style="display:none;">
          <div class="advice-title">Il consiglio per la prossima giornata</div>
          <div id="adviceDetails" class="advice-details">
            <!-- riempito via JS -->
          </div>
        </div>
      </div>

    </div>
    <button id="closeOverlay" class="close-big" type="button">CHIUDI</button>
  </div>
</div>

<script>
  // CONFIG
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxJfhGnY1HyywoXFF93ReGcmpOGV8ztulxOIB8akoKGVvRyv1Q8RqOgbtP77LJynwxccg/exec";

  // STATE
  let ultimaFormazione = [];
  let consigliato = null;

  // DOM
  const generaBtn = document.getElementById('genera');
  const svuotaBtn = document.getElementById('svuota');
  const waIcon = document.getElementById('waIcon');
  const magicStick = document.getElementById('magicStick');
  const overlay = document.getElementById('overlay');
  const overlayVideo = document.getElementById('overlayVideo');
  const adviceBox = document.getElementById('adviceBox');
  const adviceDetails = document.getElementById('adviceDetails');
  const closeOverlay = document.getElementById('closeOverlay');
  const campo = document.getElementById('campo');
  const maghetto = document.getElementById('maghetto');

  // helper: rimuovi stelline (se ci sono)
  function clearStelline(){
    const existing = Array.from(document.querySelectorAll('.star'));
    existing.forEach(s => s.remove());
    document.getElementById('campo').classList.remove('stars-active');
    // also remove class on field-container parent
    const fc = document.querySelector('.field-container');
    if(fc) fc.classList.remove('stars-active');
  }

  // crea stelline intorno al maghetto (invocare solo dopo "genera")
  function creaStelline(n=14){
    clearStelline();
    const parent = document.querySelector('.field-container');
    for(let i=0;i<n;i++){
      const s = document.createElement('div');
      s.className = 'star';
      // random pos around maghetto area
      const left = (Math.random()*90 - 10);
      const top = (Math.random()*90 - 10);
      s.style.left = (maghetto.offsetLeft + left) + 'px';
      s.style.top = (maghetto.offsetTop + top) + 'px';
      s.style.animationDelay = (Math.random()*1.6) + 's';
      parent.appendChild(s);
    }
    // start animations by toggling class
    parent.classList.add('stars-active');
    document.querySelectorAll('.star').forEach(st => st.style.opacity = 1);
  }

  // render giocatori in linea, con loghi dimensionati uguali
  function renderLine(id, players){
    const container = document.getElementById(id);
    container.innerHTML = '';
    players.forEach((p,i) => {
      const card = document.createElement('div');
      card.className = 'player-card';
      card.style.animationDelay = (i*0.08) + 's';
      // ensure logos same size (22x22), use object-fit cover
      card.innerHTML = `
        <img src="${p.logo}" alt="${p.squadra}">
        <div class="name">${p.nome}</div>
        <div class="team">${p.squadra}</div>
        ${p.ruolo === 'P' ? `<div class="mv">MV:${p.mv}</div><div class="gf">GS:${p.gs||0}</div>` 
                          : `<div class="mv">MV:${p.mv}</div><div class="gf">GF:${p.gf||0}</div><div class="ass">ASS:${p.ass||0}</div>`}
      `;
      container.appendChild(card);
    });
  }

  // genera formazione: fetch + render + abilita bacchetta + stelline
  async function generaFormazione(){
    // UI: clessidra animata
    generaBtn.classList.add('loading');
    generaBtn.innerHTML = `<span class="hourglass">‚è≥</span> Genera...`;
    // pulisci prima
    document.querySelectorAll('.line').forEach(l => l.innerHTML = '');
    clearStelline();
    consigliato = null;
    try {
      const res = await fetch(SCRIPT_URL);
      const data = await res.json();
      // group by ruolo
      const portieri = data.filter(p => p.ruolo === 'P');
      const difensori = data.filter(p => p.ruolo === 'D');
      const centro = data.filter(p => p.ruolo === 'C');
      const attacco = data.filter(p => p.ruolo === 'A');
      renderLine('goalkeeper', portieri);
      renderLine('defenders', difensori);
      renderLine('midfielders', centro);
      renderLine('forwards', attacco);
      ultimaFormazione = [...portieri, ...difensori, ...centro, ...attacco];
      // consigliato = mv pi√π alto
      if(ultimaFormazione.length) consigliato = ultimaFormazione.reduce((a,b) => ((b.mv || 0) > (a.mv || 0) ? b : a), ultimaFormazione[0]);
      // abilita bacchetta e stelline dopo render
      magicStick.classList.add('active');
      magicStick.setAttribute('aria-disabled','false');
      // crea stelline intorno al maghetto
      creaStelline(16);
    } catch (err) {
      console.error(err);
      alert('Errore nel caricamento della formazione');
    } finally {
      // restore button state (min 800ms visual)
      setTimeout(() => {
        generaBtn.classList.remove('loading');
        generaBtn.textContent = 'Genera';
      }, 800);
    }
  }

  // svuota
  function svuotaFormazione(){
    document.querySelectorAll('.line').forEach(l => l.innerHTML = '');
    ultimaFormazione = [];
    consigliato = null;
    magicStick.classList.remove('active');
    magicStick.setAttribute('aria-disabled','true');
    clearStelline();
    chiudiOverlay();
  }

  // apri video overlay: mostra overlay, fai partire video, mostra advice box che copre met√† inferiore
  function apriOverlay(){
    if(!consigliato){ alert('Genera prima la formazione!'); return; }
    // riempi advice details (nome, squadra, ruolo, MV GF ASS)
    adviceDetails.innerHTML = `
      <div style="font-weight:700; font-size:15px; margin-bottom:6px;">${consigliato.nome}</div>
      <div style="font-size:13px; margin-bottom:4px;">${consigliato.squadra} ‚Ä¢ ${consigliato.ruolo}</div>
      <div style="font-size:13px;">MV: ${consigliato.mv} &nbsp; ‚Ä¢ &nbsp; GF: ${consigliato.gf || 0} &nbsp; ‚Ä¢ &nbsp; ASS: ${consigliato.ass || 0}</div>
    `;
    // show overlay and advice box
    overlay.style.display = 'block';
    overlay.setAttribute('aria-hidden','false');
    // show advice box
    adviceBox.style.display = 'flex';
    // small fade in for video
    overlayVideo.style.opacity = 0;
    overlayVideo.play().catch(()=>{/* autoplay blocked? it's muted so normally ok */});
    // animate fade in
    setTimeout(()=> overlayVideo.style.opacity = 1, 40);
  }

  function chiudiOverlay(){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden','true');
    overlayVideo.pause();
  }

  // condividi su WhatsApp (testo con formazione)
  function condividiWhatsApp(){
    if(!ultimaFormazione || ultimaFormazione.length === 0){
      alert('Genera prima la formazione!');
      return;
    }
    let testo = 'Ecco la formazione ideale:%0A';
    ultimaFormazione.forEach(p => {
      testo += `${p.nome} (${p.squadra}) - ${p.ruolo}%0A`;
    });
    const url = `https://wa.me/?text=${encodeURIComponent(decodeURIComponent(testo))}`;
    window.open(url, '_blank');
  }

  // events
  generaBtn.addEventListener('click', generaFormazione);
  svuotaBtn.addEventListener('click', svuotaFormazione);
  waIcon.addEventListener('click', condividiWhatsApp);
  magicStick.addEventListener('click', ()=> {
    if(magicStick.classList.contains('active')) apriOverlay();
  });
  closeOverlay.addEventListener('click', chiudiOverlay);

  // accessibility: Enter to open overlay when magicStick focused
  magicStick.setAttribute('tabindex','0');
  magicStick.addEventListener('keydown', e => { if(e.key === 'Enter' && magicStick.classList.contains('active')) apriOverlay(); });

  // Ensure logos fit same size (in case of broken external images)
  // Using CSS object-fit and explicit size on <img> already handles this.

  // initial states
  magicStick.setAttribute('aria-disabled','true');

  // OPTIONAL: close overlay on ESC
 document.addEventListener('keydown', e => {
    if(e.key === 'Escape') chiudiOverlay();
  });

// --- Cambio immagine maghetto al click ---
  const immaginiMaghetto = [
    "https://i.ibb.co/8LP0zhLY/1762282260694.png",
    "https://i.ibb.co/spn2dp0t/1762338998503.png",
    "https://i.ibb.co/YB5V2rHG/IMG-20251105-084236.png",
    "https://i.ibb.co/tpvzp0w9/1762340951949.png"
  ];
  let indiceMaghetto = 0;
  maghetto.addEventListener("click", () => {
    indiceMaghetto = (indiceMaghetto + 1) % immaginiMaghetto.length;
    maghetto.src = immaginiMaghetto[indiceMaghetto];
  });

  // --- Cambio immagine nel box consiglio ---
  const overlayMaghetto = document.getElementById("overlayMaghetto");
  const immaginiMaghettoOverlay = [
    "https://i.ibb.co/23ptLRZf/1762348597465.png"
  ];
  let indiceOverlayMaghetto = 0;

  if (overlayMaghetto) {
    overlayMaghetto.addEventListener("click", () => {
      indiceOverlayMaghetto = (indiceOverlayMaghetto + 1) % immaginiMaghettoOverlay.length;
      overlayMaghetto.src = immaginiMaghettoOverlay[indiceOverlayMaghetto];
      overlayMaghetto.style.transform = "scale(1.05)";
      setTimeout(() => overlayMaghetto.style.transform = "scale(1)", 150);
    });
  }
</script>
</body>
</html>
